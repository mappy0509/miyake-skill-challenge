<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miyake Dunks Coach Admin</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { background-color: #000000; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <!-- 共通データを読み込み -->
    <script src="shared_data.js"></script>

    <script type="text/babel">
        // --- アイコンコンポーネント ---
        const UsersIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M15 21a6 6 0 00-9-5.197m0 0A5.995 5.995 0 0112 12.75a5.995 5.995 0 01-3 5.197" />
            </svg>
        );

        const CheckCircleIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
        );

        const PencilAltIcon = () => (
            <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                <path strokeLinecap="round" strokeLinejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
            </svg>
        );

        // --- 画面コンポーネント ---
        
        function ConfirmModal({ message, onConfirm, onCancel }) {
            return (
                <div className="modal-overlay">
                    <div className="bg-gray-800 w-full max-w-sm p-6 rounded-lg border border-gray-700 shadow-xl m-4">
                        <h2 className="text-xl font-bold text-white mb-4">確認</h2>
                        <p className="text-gray-300 mb-6">{message}</p>
                        <div className="flex justify-end space-x-3">
                            <button onClick={onCancel} className="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition-all">キャンセル</button>
                            <button onClick={onConfirm} className="bg-red-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-red-500 transition-all">削除する</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PlayerModal({ player, onSave, onClose }) {
            const [name, setName] = React.useState(player ? player.name : '');
            const [rankId, setRankId] = React.useState(player ? player.rankId : 1);
            const [avatarUrl, setAvatarUrl] = React.useState(player ? player.avatarUrl : '');

            const handleSubmit = () => {
                const newAvatarUrl = avatarUrl || `https://placehold.co/100x100/1a202c/48bb78?text=${name.slice(0,1)}`;
                onSave({ ...player, name, rankId: parseInt(rankId), avatarUrl: newAvatarUrl, progress: player.progress });
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="bg-gray-800 w-full max-w-lg p-6 rounded-lg border border-gray-700 shadow-xl m-4">
                        <h2 className="text-xl font-bold text-white mb-4">選手を編集</h2>
                        <div className="space-y-4">
                            <input type="text" placeholder="名前" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-400" />
                            <select value={rankId} onChange={e => setRankId(e.target.value)} className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-400">
                                {Object.entries(RANKS).map(([id, rank]) => (
                                    <option key={id} value={id}>{rank.name_jp}</option>
                                ))}
                            </select>
                            <input type="text" placeholder="アバターURL (任意)" value={avatarUrl} onChange={e => setAvatarUrl(e.target.value)} className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-400" />
                        </div>
                        <div className="flex justify-end space-x-3 mt-6">
                            <button onClick={onClose} className="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition-all">キャンセル</button>
                            <button onClick={handleSubmit} className="bg-green-500 text-black px-4 py-2 rounded-lg font-bold hover:bg-green-400 transition-all">保存</button>
                        </div>
                    </div>
                </div>
            );
        }

        function PlayerListScreen({ players, setPlayers }) {
            const [isEditModalOpen, setIsEditModalOpen] = React.useState(false);
            const [editingPlayer, setEditingPlayer] = React.useState(null);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = React.useState(false);
            const [deletingPlayer, setDeletingPlayer] = React.useState(null);

            const handleEditPlayer = (player) => {
                setEditingPlayer(player);
                setIsEditModalOpen(true);
            };
            
            const handleSavePlayer = (playerData) => {
                setPlayers(players.map(p => p.id === playerData.id ? playerData : p));
            };

            const handleDeletePlayer = (player) => {
                setDeletingPlayer(player);
                setIsConfirmModalOpen(true);
            };

            const executeDeletePlayer = () => {
                if (deletingPlayer) {
                    setPlayers(players.filter(p => p.id !== deletingPlayer.id));
                }
                setIsConfirmModalOpen(false);
                setDeletingPlayer(null);
            };

            return (
                <div className="p-4">
                    {isEditModalOpen && <PlayerModal player={editingPlayer} onSave={handleSavePlayer} onClose={() => setIsEditModalOpen(false)} />}
                    {isConfirmModalOpen && (
                        <ConfirmModal 
                            message={`選手「${deletingPlayer?.name}」を本当に削除しますか？この操作は元に戻せません。`}
                            onConfirm={executeDeletePlayer}
                            onCancel={() => setIsConfirmModalOpen(false)}
                        />
                    )}
                    
                    <div className="space-y-3">
                        {players.map(player => (
                            <div key={player.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                <div className="flex items-center space-x-4">
                                    <img src={player.avatarUrl} alt={player.name} className="w-12 h-12 rounded-full" />
                                    <div className="flex-grow">
                                        <p className="font-bold text-white">{player.name}</p>
                                        <div className="flex items-center space-x-2 mt-1">
                                            <img 
                                                src={RANKS[player.rankId].badgeUrl} 
                                                alt={RANKS[player.rankId].name_jp} 
                                                className="w-5 h-5 object-contain"
                                                onError={(e) => { e.target.style.display='none'; }}
                                            />
                                            <p className="text-sm text-gray-400">{RANKS[player.rankId].name_jp}</p>
                                        </div>
                                        <div className="w-full bg-gray-700 rounded-full h-2.5 mt-2">
                                            <div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${player.progress}%` }}></div>
                                        </div>
                                    </div>
                                    <div className="text-right">
                                        <p className="text-white font-semibold">{player.progress}%</p>
                                        <p className="text-xs text-gray-500">進捗</p>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-2 mt-3 pt-3 border-t border-gray-700">
                                    <button onClick={() => handleEditPlayer(player)} className="text-yellow-400 hover:text-yellow-300 text-sm font-semibold">編集</button>
                                    <button onClick={() => handleDeletePlayer(player)} className="text-red-500 hover:text-red-400 text-sm font-semibold">削除</button>
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        }

        function ApprovalsScreen({ approvals, setApprovals }) {
            const handleApprove = (id) => setApprovals(approvals.filter(a => a.id !== id));
            const handleReject = (id) => setApprovals(approvals.filter(a => a.id !== id));

            if (approvals.length === 0) return <div className="p-4 text-center text-gray-500">承認待ちのクエストはありません。</div>;

            return (
                <div className="p-4 space-y-3">
                    {approvals.map(approval => (
                        <div key={approval.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                            <div className="flex justify-between items-start">
                                <div>
                                    <p className="font-semibold text-gray-400 text-sm">{approval.playerName}</p>
                                    <p className="font-bold text-white text-lg mt-1">{approval.questTitle}</p>
                                </div>
                                <div className="text-green-400 font-bold">申請中</div>
                            </div>
                            <div className="flex justify-end space-x-3 mt-4">
                                <button onClick={() => handleReject(approval.id)} className="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition-all">否認</button>
                                <button onClick={() => handleApprove(approval.id)} className="bg-green-500 text-black px-4 py-2 rounded-lg font-bold hover:bg-green-400 transition-all">承認</button>
                            </div>
                        </div>
                    ))}
                </div>
            );
        }
        
        function QuestModal({ quest, onSave, onClose }) {
            const [title, setTitle] = React.useState(quest ? quest.title : '');
            const [description, setDescription] = React.useState(quest ? quest.description : '');
            const [videoUrl, setVideoUrl] = React.useState(quest ? quest.videoUrl : '');

            const handleSubmit = () => {
                onSave({ ...quest, title, description, videoUrl });
                onClose();
            };

            return (
                <div className="modal-overlay">
                    <div className="bg-gray-800 w-full max-w-lg p-6 rounded-lg border border-gray-700 shadow-xl m-4">
                        <h2 className="text-xl font-bold text-white mb-4">{quest ? 'クエストを編集' : '新しいクエストを追加'}</h2>
                        <div className="space-y-4">
                            <input type="text" placeholder="タイトル" value={title} onChange={e => setTitle(e.target.value)} className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-400" />
                            <textarea placeholder="説明" value={description} onChange={e => setDescription(e.target.value)} className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-400 h-24"></textarea>
                            <input type="text" placeholder="動画URL (YouTube Shortsなど)" value={videoUrl} onChange={e => setVideoUrl(e.target.value)} className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white focus:outline-none focus:ring-2 focus:ring-green-400" />
                        </div>
                        <div className="flex justify-end space-x-3 mt-6">
                            <button onClick={onClose} className="bg-gray-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition-all">キャンセル</button>
                            <button onClick={handleSubmit} className="bg-green-500 text-black px-4 py-2 rounded-lg font-bold hover:bg-green-400 transition-all">保存</button>
                        </div>
                    </div>
                </div>
            );
        }

        function QuestManagementScreen({ quests, setQuests }) {
            const [selectedRankId, setSelectedRankId] = React.useState(1);
            const [isEditModalOpen, setIsEditModalOpen] = React.useState(false);
            const [editingQuest, setEditingQuest] = React.useState(null);
            const [isConfirmModalOpen, setIsConfirmModalOpen] = React.useState(false);
            const [deletingQuest, setDeletingQuest] = React.useState(null);
            
            const handleAddQuest = () => {
                setEditingQuest(null);
                setIsEditModalOpen(true);
            };

            const handleEditQuest = (quest) => {
                setEditingQuest(quest);
                setIsEditModalOpen(true);
            };

            const handleDeleteQuest = (quest) => {
                setDeletingQuest(quest);
                setIsConfirmModalOpen(true);
            };

            const executeDeleteQuest = () => {
                if(deletingQuest) {
                    const updatedQuests = quests[selectedRankId].filter(q => q.id !== deletingQuest.id);
                    setQuests({ ...quests, [selectedRankId]: updatedQuests });
                }
                setIsConfirmModalOpen(false);
                setDeletingQuest(null);
            };
            
            const handleSaveQuest = (questData) => {
                if (questData.id) { // Edit
                    const updatedQuests = quests[selectedRankId].map(q => q.id === questData.id ? questData : q);
                    setQuests({ ...quests, [selectedRankId]: updatedQuests });
                } else { // Add
                    const newQuest = { ...questData, id: Date.now() }; // Simple unique ID
                    const updatedQuests = [...quests[selectedRankId], newQuest];
                    setQuests({ ...quests, [selectedRankId]: updatedQuests });
                }
            };

            return (
                <div className="p-4">
                    {isEditModalOpen && <QuestModal quest={editingQuest} onSave={handleSaveQuest} onClose={() => setIsEditModalOpen(false)} />}
                    {isConfirmModalOpen && (
                        <ConfirmModal 
                            message={`クエスト「${deletingQuest?.title}」を本当に削除しますか？`}
                            onConfirm={executeDeleteQuest}
                            onCancel={() => setIsConfirmModalOpen(false)}
                        />
                    )}

                    <div className="flex flex-wrap gap-2 mb-4">
                        {Object.keys(RANKS).map(rankId => (
                            <button 
                                key={rankId} 
                                onClick={() => setSelectedRankId(rankId)}
                                className={`px-4 py-2 rounded-lg font-semibold text-sm transition-all ${selectedRankId == rankId ? 'bg-green-500 text-black' : 'bg-gray-700 text-white hover:bg-gray-600'}`}
                            >
                                {RANKS[rankId].name_jp}
                            </button>
                        ))}
                    </div>
                    
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold text-white">{RANKS[selectedRankId].name_jp} のクエスト一覧</h2>
                        <button onClick={handleAddQuest} className="bg-green-500 text-black px-4 py-2 rounded-lg font-bold hover:bg-green-400 transition-all text-sm">新しいクエストを追加</button>
                    </div>

                    <div className="space-y-3">
                        {quests[selectedRankId] && quests[selectedRankId].length > 0 ? (
                            quests[selectedRankId].map(quest => (
                                <div key={quest.id} className="bg-gray-800 p-4 rounded-lg border border-gray-700">
                                    <p className="font-bold text-white">{quest.title}</p>
                                    <p className="text-sm text-gray-400 mt-1">{quest.description}</p>
                                    <p className="text-xs text-cyan-400 mt-1 truncate">{quest.videoUrl}</p>
                                    <div className="flex justify-end space-x-2 mt-2">
                                        <button onClick={() => handleEditQuest(quest)} className="text-yellow-400 hover:text-yellow-300 text-sm font-semibold">編集</button>
                                        <button onClick={() => handleDeleteQuest(quest)} className="text-red-500 hover:text-red-400 text-sm font-semibold">削除</button>
                                    </div>
                                </div>
                            ))
                        ) : (
                            <p className="text-center text-gray-500 py-4">このランクにはクエストがありません。</p>
                        )}
                    </div>
                </div>
            );
        }

        // --- メインアプリケーションコンポーネント ---
        function App() {
            const [currentView, setCurrentView] = React.useState('players');
            const [approvals, setApprovals] = React.useState(MOCK_APPROVALS);
            const [quests, setQuests] = React.useState(MOCK_QUESTS);
            const [players, setPlayers] = React.useState(MOCK_PLAYERS); // 選手リストをStateで管理

            const renderContent = () => {
                switch (currentView) {
                    case 'players': return <PlayerListScreen players={players} setPlayers={setPlayers} />;
                    case 'approvals': return <ApprovalsScreen approvals={approvals} setApprovals={setApprovals} />;
                    case 'quest-management': return <QuestManagementScreen quests={quests} setQuests={setQuests}/>;
                    default: return <PlayerListScreen players={players} setPlayers={setPlayers} />;
                }
            };

            return (
                <div className="bg-black min-h-screen text-white font-sans">
                    <main className="max-w-4xl mx-auto bg-gray-900 min-h-screen">
                        <header className="p-4 bg-gray-900/80 backdrop-blur-sm sticky top-0 z-10 border-b border-gray-800">
                            <h1 className="text-xl font-bold text-green-400">コーチ用管理ページ</h1>
                            <p className="text-sm text-gray-400">三宅ダンクス スキルチャレンジ</p>
                        </header>
                        
                        <nav className="flex justify-center bg-gray-800 p-2 border-b border-gray-700">
                             <button onClick={() => setCurrentView('players')} className={`w-1/3 p-3 text-center font-bold flex items-center justify-center space-x-2 ${currentView === 'players' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400'}`}>
                                <UsersIcon />
                                <span>選手一覧</span>
                            </button>
                            <button onClick={() => setCurrentView('approvals')} className={`w-1/3 p-3 text-center font-bold flex items-center justify-center space-x-2 relative ${currentView === 'approvals' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400'}`}>
                                <CheckCircleIcon />
                                <span>承認待ち</span>
                                {approvals.length > 0 && (
                                    <span className="absolute top-2 right-4 w-6 h-6 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
                                        {approvals.length}
                                    </span>
                                )}
                            </button>
                            <button onClick={() => setCurrentView('quest-management')} className={`w-1/3 p-3 text-center font-bold flex items-center justify-center space-x-2 ${currentView === 'quest-management' ? 'text-green-400 border-b-2 border-green-400' : 'text-gray-400'}`}>
                                <PencilAltIcon />
                                <span>クエスト管理</span>
                            </button>
                        </nav>
                        
                        <div>{renderContent()}</div>
                    </main>
                </div>
            );
        }

        // --- DOMにアプリをレンダリング ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>

