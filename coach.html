<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Miyake Dunks Coach Admin</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React Libraries -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <!-- Babel to transpile JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- ▼▼▼ Firebase ライブラリの読み込み ▼▼▼ -->
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <!-- ▲▲▲ Firebase ライブラリの読み込み ▲▲▲ -->

    <!-- ▼▼▼ 作成した設定ファイルと共通データを読み込み ▼▼▼ -->
    <script src="firebase_config.js"></script>
    <script src="shared_data.js"></script>
    <!-- ▲▲▲ 作成した設定ファイルと共通データを読み込み ▲▲▲ -->

    <style>
        body { background-color: #1a202c; color: #cbd5e0; }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.75);
            display: flex; align-items: center; justify-content: center; z-index: 50;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- Firebaseの初期化 ---
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        // --- 画面コンポーネント ---

        function LoginScreen({ onLogin, errorMessage, setErrorMessage }) {
            const [email, setEmail] = React.useState('');
            const [password, setPassword] = React.useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if (!email || !password) {
                    setErrorMessage("メールアドレスとパスワードを入力してください。");
                    return;
                }
                onLogin(email, password);
            };

            return (
                <div className="min-h-screen bg-gray-900 text-white flex flex-col items-center justify-center p-4">
                    <h1 className="text-3xl font-bold text-green-400 mb-2">コーチ用管理画面</h1>
                    <p className="text-gray-400 mb-8">ログインしてください</p>
                    <form onSubmit={handleLogin} className="w-full max-w-sm space-y-4">
                        <input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder="メールアドレス" className="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-400" />
                        <input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder="パスワード" className="w-full p-3 rounded-lg bg-gray-800 border border-gray-700 text-white focus:outline-none focus:ring-2 focus:ring-green-400" />
                        {errorMessage && <p className="text-red-500 text-sm">{errorMessage}</p>}
                        <button type="submit" className="w-full bg-green-500 text-black p-3 rounded-lg font-bold text-lg hover:bg-green-400 transition-all">ログイン</button>
                    </form>
                </div>
            );
        }

        function MainApp({ onLogout }) {
            const [players, setPlayers] = React.useState([]);
            const [quests, setQuests] = React.useState({});
            const [pendingApprovals, setPendingApprovals] = React.useState([]);
            const [currentView, setCurrentView] = React.useState('players');
            const [isPlayerModalOpen, setPlayerModalOpen] = React.useState(false);
            const [isQuestModalOpen, setQuestModalOpen] = React.useState(false);
            const [isConfirmModalOpen, setConfirmModalOpen] = React.useState(false);
            const [selectedPlayer, setSelectedPlayer] = React.useState(null);
            const [questToEdit, setQuestToEdit] = React.useState(null);
            const [selectedRankId, setSelectedRankId] = React.useState(1);
            const [confirmAction, setConfirmAction] = React.useState(null);
            const [confirmMessage, setConfirmMessage] = React.useState('');
            
            // --- データ取得 ---
            React.useEffect(() => {
                const unsubscribePlayers = db.collection('players').onSnapshot(snapshot => {
                    const playersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPlayers(playersData);
                });

                const unsubscribeQuests = db.collection('quests').onSnapshot(snapshot => {
                    const questsData = {};
                    snapshot.docs.forEach(doc => {
                        const quest = { id: doc.id, ...doc.data() };
                        if (!questsData[quest.rankId]) {
                            questsData[quest.rankId] = [];
                        }
                        questsData[quest.rankId].push(quest);
                    });
                    setQuests(questsData);
                });
                
                const unsubscribeApprovals = db.collection('approvals').where('status', '==', 'pending').onSnapshot(snapshot => {
                    const approvalsData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setPendingApprovals(approvalsData);
                });

                return () => {
                    unsubscribePlayers();
                    unsubscribeQuests();
                    unsubscribeApprovals();
                };
            }, []);
            
            // --- モーダル制御 ---
            const openPlayerModal = (player = null) => {
                setSelectedPlayer(player || { name: '', rankId: 1 });
                setPlayerModalOpen(true);
            };

            const openQuestModal = (quest = null) => {
                setQuestToEdit(quest);
                setQuestModalOpen(true);
            };
            
            const openConfirmModal = (message, onConfirm) => {
                setConfirmMessage(message);
                setConfirmAction(() => onConfirm);
                setConfirmModalOpen(true);
            };
            
            // --- データ保存・更新・削除 ---
            const handlePlayerSave = (playerData) => {
                if (playerData.id) {
                    const { id, ...dataToSave } = playerData;
                    db.collection('players').doc(id).update(dataToSave)
                        .then(() => setPlayerModalOpen(false))
                        .catch(error => console.error("Error updating player: ", error));
                }
            };
            
            const handleQuestSave = (formData) => {
                if (questToEdit && questToEdit.id) {
                    // Edit mode
                    db.collection('quests').doc(questToEdit.id).update(formData)
                        .then(() => setQuestModalOpen(false))
                        .catch(error => console.error("Error updating quest: ", error));
                } else {
                    // Add mode
                    const newQuestData = {
                        ...formData,
                        rankId: selectedRankId 
                    };
                    db.collection('quests').add(newQuestData)
                        .then(() => setQuestModalOpen(false))
                        .catch(error => console.error("Error adding new quest: ", error));
                }
            };
            
            const handleDeletePlayer = (playerId) => {
                openConfirmModal('本当にこの選手を削除しますか？\n選手データとアカウントが完全に削除されます。', () => {
                    db.collection('players').doc(playerId).delete()
                        .then(() => setConfirmModalOpen(false))
                        .catch(error => console.error("Error removing player: ", error));
                });
            };
            
            const handleDeleteQuest = (questId) => {
                 openConfirmModal('本当にこのクエストを削除しますか？', () => {
                    db.collection('quests').doc(questId).delete()
                        .then(() => setConfirmModalOpen(false))
                        .catch(error => console.error("Error removing quest: ", error));
                });
            };

            const handleApprove = (approval) => {
                const playerRef = db.collection('players').doc(approval.playerId);
                const approvalRef = db.collection('approvals').doc(approval.id);

                db.runTransaction(async (transaction) => {
                    const playerDoc = await transaction.get(playerRef);
                    if (!playerDoc.exists) { throw "Player does not exist!"; }

                    const playerData = playerDoc.data();
                    const currentRankId = playerData.rankId;
                    const questsForCurrentRank = quests[currentRankId] || [];
                    const maxRankId = Object.keys(RANKS).length;

                    const newCompletedQuests = [...(playerData.completedQuests || []), approval.questId];

                    const completedQuestsForRank = newCompletedQuests.filter(questId => 
                        questsForCurrentRank.some(q => q.id === questId)
                    );
                    
                    let newProgress = 0;
                    if (questsForCurrentRank.length > 0) {
                        newProgress = Math.round((completedQuestsForRank.length / questsForCurrentRank.length) * 100);
                    }

                    const updates = {
                        completedQuests: newCompletedQuests,
                        progress: newProgress,
                    };

                    if (newProgress >= 100 && currentRankId < maxRankId) {
                        updates.rankId = currentRankId + 1;
                        updates.progress = 0;
                    }

                    transaction.update(playerRef, updates);
                    transaction.update(approvalRef, { status: 'approved' });

                }).catch(error => console.error("Transaction failed: ", error));
            };

            const handleDeny = (approvalId) => {
                db.collection('approvals').doc(approvalId).delete()
                  .catch(error => console.error("Error denying quest: ", error));
            };

            // --- コンポーネント定義 ---
            const PlayerModal = ({ isOpen, onClose, onSave, player }) => {
                if (!isOpen) return null;
                const [name, setName] = React.useState(player.name);
                const [rankId, setRankId] = React.useState(player.rankId);
                return (
                    <div className="modal-overlay">
                        <div className="bg-gray-800 rounded-lg p-6 w-full max-w-md border border-gray-700">
                            <h3 className="text-xl font-bold mb-4 text-white">選手を編集</h3>
                            <input type="text" value={name} onChange={e => setName(e.target.value)} placeholder="選手名" className="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mb-4" />
                            <select value={rankId} onChange={e => setRankId(parseInt(e.target.value))} className="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mb-4">
                                {Object.entries(RANKS).map(([id, rank]) => <option key={id} value={id}>{rank.name_jp}</option>)}
                            </select>
                            <div className="flex justify-end space-x-2">
                                <button onClick={onClose} className="px-4 py-2 bg-gray-600 rounded text-white">キャンセル</button>
                                <button onClick={() => onSave({ ...player, name, rankId })} className="px-4 py-2 bg-green-500 rounded text-black">保存</button>
                            </div>
                        </div>
                    </div>
                );
            };

            const QuestModal = ({ isOpen, onClose, onSave, currentQuest }) => {
                if (!isOpen) return null;
                const [title, setTitle] = React.useState(currentQuest ? currentQuest.title : '');
                const [description, setDescription] = React.useState(currentQuest ? currentQuest.description : '');
                const [videoUrl, setVideoUrl] = React.useState(currentQuest ? currentQuest.videoUrl : '');

                const handleSaveClick = () => {
                    onSave({ title, description, videoUrl });
                };

                return (
                    <div className="modal-overlay">
                        <div className="bg-gray-800 rounded-lg p-6 w-full max-w-md border border-gray-700">
                            <h3 className="text-xl font-bold mb-4 text-white">{currentQuest ? 'クエストを編集' : 'クエストを追加'}</h3>
                            <input type="text" value={title} onChange={e => setTitle(e.target.value)} placeholder="クエスト名" className="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mb-2" />
                            <textarea value={description} onChange={e => setDescription(e.target.value)} placeholder="説明" className="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mb-2" rows="3"></textarea>
                            <input type="text" value={videoUrl} onChange={e => setVideoUrl(e.target.value)} placeholder="動画URL" className="w-full p-2 rounded bg-gray-700 border border-gray-600 text-white mb-4" />
                            <div className="flex justify-end space-x-2">
                                <button onClick={onClose} className="px-4 py-2 bg-gray-600 rounded text-white">キャンセル</button>
                                <button onClick={handleSaveClick} className="px-4 py-2 bg-green-500 rounded text-black">保存</button>
                            </div>
                        </div>
                    </div>
                );
            };
            
            const ConfirmModal = ({ isOpen, onClose, onConfirm, message }) => {
                if (!isOpen) return null;
                return (
                    <div className="modal-overlay">
                        <div className="bg-gray-800 rounded-lg p-6 w-full max-w-sm border border-gray-700 text-center">
                            <p className="text-white mb-6 whitespace-pre-line">{message}</p>
                            <div className="flex justify-center space-x-4">
                                <button onClick={onClose} className="px-6 py-2 bg-gray-600 rounded text-white">キャンセル</button>
                                <button onClick={onConfirm} className="px-6 py-2 bg-red-600 rounded text-white">削除する</button>
                            </div>
                        </div>
                    </div>
                );
            };

            return (
                <div className="max-w-4xl mx-auto p-4">
                    <header className="flex justify-between items-center mb-6">
                        <h1 className="text-2xl font-bold text-green-400">コーチ用管理画面</h1>
                        <button onClick={onLogout} className="text-gray-400 hover:text-white text-sm bg-gray-700 px-3 py-1 rounded">ログアウト</button>
                    </header>
                    <nav className="flex space-x-2 mb-6 border-b border-gray-700">
                        <button onClick={() => setCurrentView('players')} className={`py-2 px-4 font-semibold ${currentView === 'players' ? 'border-b-2 border-green-400 text-white' : 'text-gray-400'}`}>選手一覧</button>
                        <button onClick={() => setCurrentView('approvals')} className={`relative py-2 px-4 font-semibold ${currentView === 'approvals' ? 'border-b-2 border-green-400 text-white' : 'text-gray-400'}`}>
                            承認待ち
                            {pendingApprovals.length > 0 && <span className="absolute top-1 right-1 flex h-4 w-4 items-center justify-center rounded-full bg-red-500 text-xs font-bold text-white">{pendingApprovals.length}</span>}
                        </button>
                        <button onClick={() => setCurrentView('quests')} className={`py-2 px-4 font-semibold ${currentView === 'quests' ? 'border-b-2 border-green-400 text-white' : 'text-gray-400'}`}>クエスト管理</button>
                    </nav>

                    {currentView === 'players' && (
                        <div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                {players.map(player => (
                                    <div key={player.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700">
                                        <p className="font-bold text-white">{player.name}</p>
                                        <p className="text-sm text-gray-400">{RANKS[player.rankId]?.name_jp || 'ランク未設定'}</p>
                                        <div className="w-full bg-gray-700 rounded-full h-2 my-2">
                                            <div className="bg-green-500 h-2 rounded-full" style={{ width: `${player.progress || 0}%` }}></div>
                                        </div>
                                        <div className="flex justify-end space-x-2 mt-2">
                                            <button onClick={() => openPlayerModal(player)} className="text-xs bg-blue-500 text-white px-2 py-1 rounded">編集</button>
                                            <button onClick={() => handleDeletePlayer(player.id)} className="text-xs bg-red-500 text-white px-2 py-1 rounded">削除</button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    {currentView === 'approvals' && (
                        <div className="space-y-4">
                             {pendingApprovals.length > 0 ? (
                                pendingApprovals.map(approval => (
                                    <div key={approval.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700 flex justify-between items-center">
                                        <div>
                                            <p className="font-bold text-white">{approval.playerName}</p>
                                            <p className="text-sm text-gray-400">クエスト: {approval.questTitle}</p>
                                        </div>
                                        <div className="flex space-x-2">
                                            <button onClick={() => handleDeny(approval.id)} className="bg-red-500 text-white px-3 py-1 rounded text-sm">否認</button>
                                            <button onClick={() => handleApprove(approval)} className="bg-green-500 text-black px-3 py-1 rounded text-sm">承認</button>
                                        </div>
                                    </div>
                                ))
                             ) : (
                                <div className="text-center text-gray-400 py-8">
                                    現在承認待ちのクエストはありません。
                                </div>
                             )}
                        </div>
                    )}

                     {currentView === 'quests' && (
                         <div>
                            <div className="flex flex-wrap gap-2 mb-4">
                                {Object.entries(RANKS).map(([rankId, rank]) => (
                                    <button key={rankId} onClick={() => setSelectedRankId(parseInt(rankId, 10))} className={`px-3 py-1 text-sm rounded-full ${selectedRankId === parseInt(rankId, 10) ? 'bg-green-500 text-black' : 'bg-gray-700 text-gray-300'}`}>{rank.name_jp}</button>
                                ))}
                            </div>
                             <button onClick={() => openQuestModal()} className="mb-4 bg-green-500 text-black px-4 py-2 rounded">新しいクエストを追加</button>
                             <div className="space-y-3">
                                {(quests[selectedRankId] || []).map(quest => (
                                    <div key={quest.id} className="bg-gray-800 rounded-lg p-4 border border-gray-700 flex justify-between items-center">
                                         <div>
                                            <p className="font-bold text-white">{quest.title}</p>
                                            <p className="text-sm text-gray-400">{quest.description}</p>
                                        </div>
                                         <div className="flex space-x-2">
                                            <button onClick={() => openQuestModal(quest)} className="text-xs bg-blue-500 text-white px-2 py-1 rounded">編集</button>
                                            <button onClick={() => handleDeleteQuest(quest.id)} className="text-xs bg-red-500 text-white px-2 py-1 rounded">削除</button>
                                        </div>
                                    </div>
                                ))}
                             </div>
                         </div>
                     )}
                     
                    <PlayerModal isOpen={isPlayerModalOpen} onClose={() => setPlayerModalOpen(false)} onSave={handlePlayerSave} player={selectedPlayer} />
                    <QuestModal isOpen={isQuestModalOpen} onClose={() => setQuestModalOpen(false)} onSave={handleQuestSave} currentQuest={questToEdit} />
                    <ConfirmModal isOpen={isConfirmModalOpen} onClose={() => setConfirmModalOpen(false)} onConfirm={confirmAction} message={confirmMessage} />
                </div>
            );
        }

        // --- メインアプリケーションコンポーネント ---
        function App() {
            const [user, setUser] = React.useState(null);
            const [isLoading, setIsLoading] = React.useState(true);
            const [errorMessage, setErrorMessage] = React.useState('');

            React.useEffect(() => {
                const unsubscribe = auth.onAuthStateChanged(user => {
                    setUser(user);
                    setIsLoading(false);
                });
                return () => unsubscribe();
            }, []);

            const handleLogin = (email, password) => {
                setErrorMessage('');
                auth.signInWithEmailAndPassword(email, password)
                    .catch(error => {
                        setErrorMessage('メールアドレスまたはパスワードが間違っています。');
                    });
            };

            const handleLogout = () => {
                auth.signOut();
            };

            if (isLoading) {
                return <div className="bg-gray-900 text-white min-h-screen flex items-center justify-center">読み込み中...</div>;
            }

            if (user) {
                return <MainApp onLogout={handleLogout} />;
            }

            return <LoginScreen 
                        onLogin={handleLogin} 
                        errorMessage={errorMessage}
                        setErrorMessage={setErrorMessage}
                    />;
        }

        // --- DOMにアプリをレンダリング ---
        const container = document.getElementById('root');
        const root = ReactDOM.createRoot(container);
        root.render(<App />);

    </script>
</body>
</html>
